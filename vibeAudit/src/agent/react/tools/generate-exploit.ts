import { ReActTool } from './index';
import OpenAI from 'openai';

export class GenerateExploitTool implements ReActTool {
    definition = {
        name: 'generate_exploit',
        description: 'Generates a complete executable Foundry test file (Exploit.t.sol) to prove a specific vulnerability on an EVM chain.',
        parameters: {
            type: 'object',
            properties: {
                vulnerabilityTitle: {
                    type: 'string',
                    description: 'Title or short name of the vulnerability to exploit.',
                },
                vulnerabilityDescription: {
                    type: 'string',
                    description: 'Detailed explanation of how the vulnerability works and how to exploit it.',
                },
                targetCode: {
                    type: 'string',
                    description: 'The source code of the vulnerable contract.',
                }
            },
            required: ['vulnerabilityTitle', 'vulnerabilityDescription', 'targetCode'],
        },
    };

    async execute(args: { vulnerabilityTitle: string; vulnerabilityDescription: string; targetCode: string }): Promise<string> {
        if (!args.vulnerabilityTitle || !args.vulnerabilityDescription || !args.targetCode) {
            return 'Error: Missing required arguments.';
        }

        try {
            const openai = new OpenAI({
                apiKey: process.env.GROQ_API_KEY || 'dummy',
                baseURL: 'https://api.groq.com/openai/v1',
            });

            const prompt = `You are an elite smart contract security auditor. Your task is to write a complete, executable Foundry test file (Exploit.t.sol) to prove the following vulnerability:
            
Vulnerability: ${args.vulnerabilityTitle}
Description: ${args.vulnerabilityDescription}

Here is the target source code:
\`\`\`solidity
${args.targetCode}
\`\`\`

Write ONLY the complete Foundry test code (do not include markdown formatting or explanations). It must include standard setup, token mocking if necessary, and a \`test_Exploit()\` function that demonstrates the vulnerability.`;

            const completion = await openai.chat.completions.create({
                model: 'llama-3.3-70b-versatile',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.1,
            });

            const response = completion.choices[0]?.message?.content || '';
            const testCode = response.replace(/```solidity|```/g, '').trim();

            if (testCode.length > 0) {
                return `Generated Foundry Exploit Code:\n\n\`\`\`solidity\n${testCode}\n\`\`\``;
            }

            return 'Error: Failed to generate exploit code.';
        } catch (error) {
            return `Error executing generate_exploit: ${(error as Error).message}`;
        }
    }
}
